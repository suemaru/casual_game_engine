# カードショーケース振り返りと次期要件

## 1. デモ振り返りサマリー
- **目的**: カード1枚でホログラム演出・視差・インタラクションを兼ね備えたビジュアルデモを短期で成立させる。
- **成果**: レイヤー構造と視差・チルト演出により、体験価値の核となる「触れる楽しさ」の片鱗を確認。
- **課題**: マスク形状・UI配置・モバイル対応・厚み表現の欠如が、量産化や今後の機能拡張における阻害要因として顕在化。

## 2. うまくいった点と成功要因
1. **レイヤー分離 (subject/background/frame/gloss)**
   - 明確なレイヤー管理により、アセット差し替え対応が容易。
   - HologramMaterial を利用したパラメトリック制御が拡張性を担保。
2. **チルト＋視差の操作感**
   - カーソル追従に慣性を持たせたことで、直感的で「ぐりぐり」した挙動を実現。
   - デモの魅力となるフィードバックループが成立。
3. **カードデータ仕様の下地**
   - `cardSpec.ts` によるメタデータの分離が、今後のカードコレクション機能の足場に。

## 3. うまくいかなかった点と要因分析
| 課題 | 発生要因 | 影響 | 改善の方向性 |
| --- | --- | --- | --- |
| 光沢マスクが角丸に追随せず矩形で露出 | `gloss` をスクリーンスペース矩形で合成しており、ジオメトリと独立 | 縁ムラ・没入感低下 | 角丸ジオメトリ or 角丸マスクテクスチャに統一し、法線ベースで制御 |
| UIレイアウトが画面サイズに依存 | CSS 絶対配置＋レスポンシブ試行錯誤 | カード内の情報がズレ、印刷カード風に見えない | Card 内部をコンポーネントレイアウト化し、カード基準でマージンとタイポスケールを固定 |
| モバイル非対応 | ポインタイベント前提・ホイールイベント依存、デバイス姿勢の想定欠落 | プラットフォーム制約でデモが広められない | Pointer API＋モーションセンサー代替、エミュレータ検証パイプ確立 |
| カード厚みの欠如 | 平面メッシュのみ、ライト設定も正面のみ | 立体感不足、将来の差別化要素を逃した | 3D ジオメトリ（薄箱）＋法線マップ＋エッジハイライト導入 |
| 角丸前提の設計不足 | 初期に矩形でUI/マスク決定 | 後工程でのリファクタコスト増加 | 角丸を核仕様にしてから各レイヤー・UIを組み直す |

## 4. 改善アーキテクチャ提案
### 4.1 表現レイヤー構造 (次版)
1. **Geometry**: 角丸長方形のベベル付き 3D メッシュ (CardCoreMesh)
2. **Materials**:
   - BaseMaterial: subject + background + frame を PBR 的に合成
   - GlossLayer: 角丸マスク付きスクリーンスペース + 法線依存ハイライト
   - RimLight: エッジの厚み表現用マテリアル
3. **Post FX**: Bloom/ChromaticAberration を軽量で可搬なシェーダに抽象化
4. **Interaction**: Pointer / MotionSensor を抽象化する CardInputController

### 4.2 UIレイアウトシステム
- カード内を **カード座標系 (width=1.0, height=1.0)** で定義し、CSS 側はスケール変換のみ。
- テキストスタイル・余白・角丸半径を `CardLayoutSpec` として JSON/TS に明示。
- レイアウト調整用に **制御パネル (Storybook or internal dev panel)** を用意し、プレビューを自動化。

### 4.3 モバイル対応指針
- `pointerdown/move/up` + passive `touch` でイベント統合。wheel依存を排除。
- `DeviceOrientationEvent` が許可されないケースに備え、 **仮想スティック UI** を fallback として提供。
- Safari/iOS の WebGL 制限を満たすテクスチャサイズと圧縮形式に見直し。
- 主要端末（iPhone 13/15, Pixel 7）での FPS 計測を CI に追加。
- 品質プリセット (`quality=high/medium/mobile`) を明文化し、ホログラムやポストエフェクトの強度を端末別に自動調整。

### 4.4 厚みと立体感の表現
- 0.6mm 程度のエッジ厚みを持つ薄箱メッシュを生成。
- フレーム用テクスチャとは別に **Edge Normal Map** を用意し、斜めチルト時の反射を強化。
- 背面の存在を演出するため、反転面を暗めのマテリアルで追加。ただし視認不要時は非表示に。

### 4.5 PC限定エフェクトとモバイル品質維持
- 粒子空間や大規模ポストエフェクトは **PC プリセット専用** コンポーネントに分離し、モバイルでは読み込まない。
- ホログラム層はモバイルでもリッチさを維持するため、`flow map` + 角丸マスクを軽量テクスチャに集約し、GPU 負荷を管理。
- Bloom/ColorGrading はモバイル向けに擬似的な LUT 合成へフェイルオーバーさせ、視覚表現を保ったまま処理を簡略化。
- 品質プリセットに応じて `Canvas` の dpr/antialias を切り替え、指操作の滑らかさと描画負荷をバランス。

## 5. 次期開発に向けた仕様（抜粋）
### 5.1 カードデータ仕様 (CardSpec v1)
- `id: string`
- `rarity: "common" | "rare" | "legend"`（表現差分管理）
- `title: LocalizedText`
- `subtitle: LocalizedText`
- `stats: Array<{ label: string; value: string }>`
- `story: string`（最大 120 文字）
- `artwork: { subject: TextureRef; background: TextureRef }`
- `frameStyle: FrameStyleId`
- `hologram: { intensity: number; pattern: HoloPatternId }`
- `animationProfile: TiltProfileId`

### 5.2 表示コンポーネント Contract
- `CardCanvas`
  - props: `cardSpec`, `interactionMode`, `environmentPreset`
  - emits: `onViewMetric(metric: CardRuntimeMetric)`
- `CardOverlay`
  - props: `layoutSpec`, `copySpec`
  - 機能: カード内コピーを DOM + WebGL で同期レンダリング
- `CardControls`
  - 可搬な UI（再生/停止、バーストトリガ、姿勢プリセット）

### 5.3 パフォーマンス指標
- LCP ≤ 1.5s (デスクトップ), ≤ 2.0s (モバイル)
- 60fps を目標、デグレ最小 45fps
- メモリ使用量 (GPU) ≤ 350MB
- テクスチャ総容量 ≤ 32MB (圧縮後)

### 5.4 QA チェックリスト (更新版)
1. 角丸マスクとホロハイライトの境界が一致
2. カード内テキストが 320px 幅でも崩れない
3. モバイルでバースト操作が 5/5 回成功
4. 厚み表現のための rim ライトが暗背景でも視認可能
5. `CardSpec` 不整合時にフォールバック画像/文言を表示

## 6. 次版ロードマップ案
1. **v0.3.0**: 角丸ジオメトリ + Gloss マスク再設計 + CardLayoutSpec 実装
2. **v0.3.1**: モバイル入力統合・端末検証パイプライン整備
3. **v0.3.2**: 厚みメッシュ + Edge Normal Map + rim light 実装
4. **v0.3.3**: パフォーマンス最適化 (テクスチャ圧縮、自動LOD)
5. **v0.4.0**: コレクション機能初期実装 (カードビューア、メタ情報表示)

## 7. アクションアイテム
- [ ] 角丸カードメッシュ + マスク生成スクリプトを作成
- [ ] CardLayoutSpec と Storybook プレビュー環境を整備
- [ ] Pointer/Motion 抽象レイヤーの API 設計
- [ ] モバイル想定の操作要件を書面化し、QA に共有
- [ ] テクスチャパイプライン（解像度・圧縮）をドキュメント化
- [ ] PC 限定エフェクトとモバイル軽量プリセットの切り替え仕様を実装設計に反映

---
このドキュメントは、次フェーズで「カード体験をプロダクト仕様として固める」ための合意形成ベースです。これを叩き台に、実装規模と要件を詳細化してください。
