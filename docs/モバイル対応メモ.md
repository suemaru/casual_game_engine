## カードショーケース：モバイル完全対応 仕様書 v1.0

### 0\. 目的と成功条件（Definition of Done）

- **目的** ：iOS Safari/Chrome（WebKit）および Android Chrome で **滑らかに“ぐりぐり”動く** カード体験を提供する。
- **完了条件**
	- iPhone 12 以降 / Pixel 6 以降の実機で **55fps 以上** を安定維持。
	- 初回 LCP **≤ 2.0s（モバイル）** 。 card\_showcase\_retrospective
	- **ドラッグ／スワイプでチルト＋慣性** 、 **タップ演出（バースト）** 、 **±9〜12°跨ぎのハネ** が再現。
	- **Reduced Motion** では動きが 50% 減衰。 context
	- **角丸マスクとグロス（ホロ）境界の一致** 、 **320px 幅でもUI崩れなし** 。 card\_showcase\_retrospective

---

## 1\. アーキテクチャ（現行ベースに差分追加）

### 1.1 レイヤ構成（再確認）

- **CardShowcase** ：DOM コンテナ／入力イベントの集約と配信。 `burstSignal` / `kickSignal` を Canvas/Overlay 両方へ。 card\_showcase\_demo\_spec
- **CardCanvas** ：R3F `Canvas` 初期化。モバイル時の **DPR/AA/Tone** を可変。品質監視で `quality=high/medium/low` を切替。 card\_showcase\_demo\_spec
- **CardScene** ：テクスチャ・マテリアル初期化、 `CardController.update()` から 3D 姿勢・ホロを更新。 card\_showcase\_demo\_spec
- **CardOverlay** ：DOM の文言・数値表示（CSS で 3D と同傾き同期）。 card\_showcase\_demo\_spec
- **CardController** ： **入力の単一点** 。ポインタ操作±12°、クリック/キック検知、慣性・スナップバックなどを集約。 card\_showcase\_demo\_spec

> **背景** ：現行は Plane＋スクリーンスペース合成により、 **角丸とグロス境界がズレる** 、 **モバイルは品質を落とすだけ** 等の制約がある。次版では角丸統一とモバイル品質プリセットを明文化。 card\_showcase\_demo\_spec

---

## 2\. 入力レイヤ再設計（モバイル最優先）

### 2.1 DOM/CSS 必須設定（最重要）

- **対象** ：インタラクティブ最上位コンテナ（ `CardShowcase` の root）
- **CSS** ：
- **meta viewport** ： `<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">`  
	※アクセシビリティのため `user-scalable=no` は使わない（Reduced Motion利用）。

> **狙い** ：iOS の既定ジェスチャ（スクロール・ゴム）が Pointer イベントを奪うのを抑止。現行構成では `CardShowcase` が **入力の集約点** なので、ここで確実に止める。 card\_showcase\_demo\_spec

### 2.2 Pointer Capture／イベント統合

- **方針** ： `pointerdown/move/up/cancel` に統一。 `enter/leave` 依存をやめ、 **capture** で境界跨ぎの欠落を防止。 `touchmove` の `preventDefault` は **最後の保険** として非パッシブで 1 箇所のみ。
- **チルト仕様** ：最大 **±12°** 、慣性減衰 **0.92** 、スナップバック **≈360ms** （臨界減衰寄り）を維持。 context

### 2.3 フォールバック方針

- **デバイス姿勢（DeviceOrientation） **は** 採用しない（v1.0）** ：許可フローの複雑化を避け、 **ドラッグ操作のみで完結** 。
- \*\*将来（v1.1+）\*\*で `CardInputController` に Motion をプラガブル追加（許可不可時は自動で Pointer 専用へ）。 card\_showcase\_retrospective

---

## 3\. レイアウトと角丸・グロスの統一

### 3.1 角丸マスクの一元化（必須）

- **要件** ： **角丸ジオメトリ or 角丸テクスチャ** を **全レイヤ共通** で参照し、 **グロス（ホロ）境界** と **フレーム** の形状を一致させる。
- **理由** ：前回のズレ（矩形グロスの露出）で没入感が低下していた。 card\_showcase\_retrospective

### 3.2 UI のカード座標系レイアウト

- **カード内部** を **width=1, height=1** の **カード座標** で組み、 **CSS 側はスケールのみ** 。
- **文字** ：320px 幅でも崩れない字間調整と縮小ロジックを持つ。 card\_showcase\_retrospective

---

## 4\. パフォーマンス設計（モバイル品質プリセット）

### 4.1 品質プリセット（明文化）

| プリセット | DPR | AA | Holo 粒度 | 視差 | PostFX |
| --- | --- | --- | --- | --- | --- |
| **high** （PC） | 1.5–2.0 | on | 高 | 100% | あり |
| **medium** （標準） | 1.2–1.5 | off | 中 | 75% | 簡易 |
| **mobile** （既定） | 1.0–1.2 | off | 中-低 | 50% | なし or LUT 代替 |

- 起動時に `PerformanceMonitor` で係数を取得し、モバイルは既定 **`mobile`** 。負荷が上がれば自動デグレード。 card\_showcase\_demo\_spec
- **PC限定エフェクトは分離ロード** 。モバイルは **軽量化合成** とする。 card\_showcase\_retrospective

### 4.2 予算

- **LCP** ≤ 2.0s（モバイル）／ **60fps 目標** ／最低 55fps。テクスチャ総容量 ≤ **32MB（圧縮後）** 。 card\_showcase\_retrospective

---

## 5\. ホログラム（Holo）と演出

### 5.1 Holo 合成（位相×グラデ）

- **方式** ： **位相テクスチャ × グラデーション** の合成（細ラメ＋プリズムの 2 ブレンド）。 **角度依存** で流動。 context
- **中央反射マスク** ：正面 **±8〜10°** で抑制（既定 ±8°）。 context

### 5.2 トリガ（タップ／ハネ）

- **タップ** （≤200ms & ≤10px 移動）： **0.2–0.3s の鋭い光筋（バースト）** 。
- **角度しきい値** （±9〜12°跨ぎ）： **輝度 +15%／彩度 +10% を 120ms** 、180ms で減衰。
- 上記は `CardController` の **`onBurst` / `onKick`** を継続利用。 card\_showcase\_demo\_spec

---

## 6\. 非機能要件とアクセシビリティ

- **Reduced Motion** ：振幅 50%（速度維持）。 context
- **テキスト可読性** ：UI 文字はソフトシャドウ＋外枠。
- **セーフティ** ：Motion API 権限は未使用（v1.0）。
- **メトリクス** ： `onViewMetric` で FPS / DPR / quality を emit（画面外ログ可）。 card\_showcase\_retrospective

---

## 7\. アセット仕様（再掲・要点）

- **メイン画像** ： **1600×2240px / PNG（sRGB）** 、安全域：左右 ≥ 80px、上下 ≥ 130px。 context
- **テキスト** ：タイトル ≤ 全角12、パラメータ ≤4 項、ストーリー 80–140 字。 context

---

## 8\. QA／実機テスト計画（必須ケース）

### 8.1 端末マトリクス

- **iOS** ：iPhone 12 / 13 / 15（最新 OS）
- **Android** ：Pixel 6 / 8
- **PC** ：Chrome / Safari / Edge（参考）

### 8.2 シナリオ

1. **ドラッグ全方向** ：上下左右の追従、capture 跨ぎの途切れ無し。
2. **タップ** ：5/5 回バースト発火。 card\_showcase\_retrospective
3. **±10°跨ぎ** ：ハネ効果の過不足なし（目潰し回避）。
4. **Reduced Motion** ：動き 50% 減。
5. **角丸＆グロス** ：境界一致、端の露出なし。 card\_showcase\_retrospective
6. **320px 幅** ：UI 崩れ無し。 card\_showcase\_retrospective
7. **LCP** ：≤ 2.0s（4G 相当回線で確認）。 card\_showcase\_retrospective

---

## 9\. 実装差分（概念コード）

### 9.1 CardShowcase（ハンドラ差分）

### 9.2 CSS（抜粋）

### 9.3 CardCanvas（モバイル初期値）

- **DPR** ： `[1, 1.2]` 、 **antialias** ： `false` 、 **quality** ： `"mobile"` を初期化。 card\_showcase\_demo\_spec

---

## 10\. ロードマップ（モバイル以降の改良）

- **v1.1** ：角丸メッシュ＋Rim Light／Edge Normal で厚み強化。 card\_showcase\_retrospective
- **v1.2** ：Motion 入力の任意追加（CardInputController を抽象化）。 card\_showcase\_retrospective

---

## 11\. PR テンプレート（そのまま使えます）

**Title**: feat(card): モバイル完全対応（Pointer Capture / touch-action / quality presets）

**Summary**

- iOS/Android でドラッグ操作が確実に届くよう **`touch-action:none`** と **Pointer Capture** を導入。
- Overlay のヒットテストを無効化（ `pointer-events:none` ）。
- `CardCanvas` の **モバイル品質プリセット** （DPR, AA, Holo 粒度, 視差）を明文化。
- QA チェックリストと LCP/FPS 目標を追加。

**Context / Why**

- 既存デモは **Pointer 依存＋モバイル未対応** が課題で、イベントが WebKit 既定動作に奪われていた。 card\_showcase\_retrospective
- `CardController` を中心に入力を一元管理しているため、 **入力層の最小差分修正** で安全に改善可能。 card\_showcase\_demo\_spec

**Changes**

- `CardShowcase.module.css` ： `touch-action:none` / `overscroll-behavior:none` / `-webkit-user-select:none` / `-webkit-tap-highlight-color:transparent` 追加。
- `CardOverlay` root： `pointer-events:none` 。 card\_showcase\_demo\_spec
- `CardShowcase.tsx` ： `setPointerCapture/releasePointerCapture` 追加、 `pointercancel` ハンドラ実装。
- `CardCanvas.tsx` ：モバイル初期値を `DPR=[1,1.2]` 、 `antialias=false` 、 `quality="mobile"` に固定。 card\_showcase\_demo\_spec

**Acceptance Criteria**

- iPhone 12/15, Pixel 6 にて 55fps 以上、LCP ≤ 2.0s。 card\_showcase\_retrospective
- 角丸とグロス境界が一致、320px 幅でも UI 崩れ無し。 card\_showcase\_retrospective card\_showcase\_retrospective
- タップ（5回）で必ずバースト、±10°跨ぎでハネ演出。 card\_showcase\_demo\_spec

---

## 12\. リスクと回避策

- **iOS の pinch/ダブルタップズーム** ： `touch-action:none` で大半は抑制。ズーム事故が残る端末では **容認** し、操作は **Pointer Capture** で維持。
- **過度な輝度** ：中央反射マスクの角度を **±8°** に設定し、ピーク輝度上限を調整。 context
- **低速端末の発熱** ：自動デグレードで Holo 粒度・視差を 1/2、PostFX を LUT 代替へ。 card\_showcase\_retrospective

---

### 付録 A：実装時の迷いどころ早見表

- **イベントが届かない** → `.container{ touch-action:none }` が効いているか／ `pointer-events:none` が Overlay に付与されているか。
- **指を境界で外すと止まる** → `setPointerCapture` を `pointerdown` で必ず呼んでいるか。
- **眩しすぎて潰れる** → 中央反射マスク角を ±8→±10 に広げる、または Holo 強度を 0.75→0.6 に。 context